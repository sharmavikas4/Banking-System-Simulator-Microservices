package com.util;

import io.github.resilience4j.circuitbreaker.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class CircuitBreakerLoggingConfig {

    @Bean
    public CircuitBreakerRegistry circuitBreakerRegistry() {
        CircuitBreakerRegistry registry = CircuitBreakerRegistry.ofDefaults();

        registry.getEventPublisher()
            .onEntryAdded(event -> log.info("CB added: {}", event.getAddedEntry().getName()))
            .onEntryRemoved(event -> log.info("CB removed: {}", event.getRemovedEntry().getName()));

        registry.circuitBreaker("accountServiceCB")
            .getEventPublisher()
            .onStateTransition(event ->
                log.warn("⚡ CircuitBreaker '{}' state changed from {} → {}",
                        event.getCircuitBreakerName(),
                        event.getStateTransition().getFromState(),
                        event.getStateTransition().getToState())
            )
            .onError(event ->
                log.error("❌ CircuitBreaker '{}' error: {}", 
                        event.getCircuitBreakerName(), event.getThrowable().toString())
            )
            .onSuccess(event ->
                log.info("✔ CircuitBreaker '{}' success", event.getCircuitBreakerName())
            );

        return registry;
    }
}
