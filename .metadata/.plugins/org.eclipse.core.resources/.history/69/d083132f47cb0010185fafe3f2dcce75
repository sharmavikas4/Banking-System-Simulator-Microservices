package com.service.impl;

import org.springframework.stereotype.Service;

@Service
public class AccountService {

    private static final Logger LOGGER = LoggerFactory.getLogger(AccountService.class);

    @Autowired
    private AccountServiceClient accountServiceClient;

    @CircuitBreaker(name = "accountServiceCB", fallbackMethod = "updateBalanceFallback")
    @Retry(name = "accountServiceRetry")
    @TimeLimiter(name = "accountServiceCB")
    public CompletableFuture<AccountResponse> updateBalance(String accountNumber, AccountTransactionRequest request) {

        return CompletableFuture.supplyAsync(() -> {
            LOGGER.info("Calling Account Service for account={}, updateType={}",
                    accountNumber, request.getUpdateType());

            AccountResponse response = accountServiceClient.updateBalance(accountNumber, request);

            LOGGER.info("Received response from Account Service for account={}, status={}",
                    accountNumber, response.status());

            return response;
        });
    }

    /**
     * FALLBACK
     */
    public CompletableFuture<AccountResponse> updateBalanceFallback(
            String accountNumber,
            AccountTransactionRequest request,
            Throwable exception
    ) {
        LOGGER.error("Fallback triggered for account={}, reason={}",
                accountNumber, exception.getMessage());

        AccountResponse fallbackResponse = new AccountResponse(
                accountNumber,
                0,
                "FAILED â€” Account Service is down"
        );

        return CompletableFuture.completedFuture(fallbackResponse);
    }
}

